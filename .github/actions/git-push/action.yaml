name: Update current git to latest & Push changes
description: |
  Run git commit & push if there are any changes.
  Also update ref before push.
inputs:
  commit-message:
    description: "commit message"
    required: true
  repository:
    description: "target repository"
    required: false
    default: "${{ github.repository }}"
  ref:
    description: "checkout ref to make git ref up to date."
    required: true
  github-token:
    description: "github token"
    required: true
  sign-commits:
    description: "whether to sign commits."
    required: false
    default: "true"
  working-directory:
    description: "working directory to run git commands."
    required: false
    default: "."
outputs:
  changed:
    description: "whether there is any change to commit."
    value: ${{ steps.diff.outputs.changed }}
  changed-files:
    description: "list of changed files (one per line)"
    value: ${{ steps.diff.outputs.changed-files }}
  changed-dirs:
    description: "changed directories with stats"
    value: ${{ steps.diff.outputs.changed-dirs }}

runs:
  using: "composite"
  steps:
    # o: `git status --porcelain=v1` could get both modified and newly added.
    # x: `git diff-index --quiet HEAD --` could get modified but not for newly
    - name: Diff
      id: diff
      run: |
        STATUS_OUTPUT=$(git status --porcelain=v1)
        if [ -z "$STATUS_OUTPUT" ]; then
          echo "No changes."
          echo "changed=0" | tee -a "${GITHUB_OUTPUT}"
        else
          echo "Changes detected."
          echo "changed=1" | tee -a "${GITHUB_OUTPUT}"

          # Extract file names from status output
          FILES=$(echo "$STATUS_OUTPUT" | awk '{print $2}')
          {
            echo "changed-files<<EOF"
            echo "$FILES"
            echo "EOF"
          } | tee -a "${GITHUB_OUTPUT}"

          # Get directory stats
          DIRS=$(git diff --dirstat=files HEAD 2>/dev/null || echo "")
          {
            echo "changed-dirs<<EOF"
            echo "$DIRS"
            echo "EOF"
          } | tee -a "${GITHUB_OUTPUT}"
        fi
      shell: bash
      continue-on-error: true
      working-directory: ${{ inputs.working-directory }}

    - name: Create signed commit via GitHub API
      id: signed-commit
      if: ${{ steps.diff.outputs.changed == '1' && inputs.sign-commits == 'true' }}
      uses: ./.github/actions/signed-commit
      with:
        commit-message: ${{ inputs.commit-message }}
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}
        github-token: ${{ inputs.github-token }}
        working-directory: ${{ inputs.working-directory }}

    - name: git commit (legacy, no signature)
      if: ${{ steps.diff.outputs.changed == '1' && inputs.sign-commits == 'false' }}
      run: |
        git remote set-url origin "https://github-actions:${GITHUB_TOKEN}@github.com/${REPOSITORY}"
        git config user.name  "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git checkout -b "${GIT_REF}"

        git add .
        git commit -m "$COMMIT_MESSAGE"
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        COMMIT_MESSAGE: ${{ inputs.commit-message }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GIT_REF: ${{ inputs.ref }}
        REPOSITORY: ${{ inputs.repository }}

    - name: git push
      if: ${{ steps.diff.outputs.changed == '1' && inputs.sign-commits == 'false' }}
      run: |
        max_retries=3
        retry_count=0

        while [ $retry_count -lt $max_retries ]; do
          echo "try 'git push' ($((retry_count + 1))/${max_retries}) ..."
          if git push origin "$GIT_REF"; then
            echo "Push succeeded."
            exit 0
          else
            echo "Push failed with exit code: $?"
          fi

          # Push failed, increment retry count
          echo "Incrementing retry count from $retry_count to $((retry_count + 1))"
          ((retry_count++))
          echo "Current retry count: $retry_count"

          # If we haven't exceeded max retries, try to rebase and retry
          if [ $retry_count -lt $max_retries ]; then
            echo "Failed to push, try 'git pull --rebase' to resolve ..."
            if ! git pull origin "$GIT_REF" --rebase --strategy=recursive -X theirs; then
              echo "'git pull --rebase' has problem, you need resolve conflict ..."
              exit 1
            fi
            echo "Rebase succeeded, will retry push."
          fi
        done

        echo "max retry reached, but failed to push."
        exit 1
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GIT_REF: ${{ inputs.ref }}
