name: Update current git to latest & Push changes
description: |
  Run git commit & push if there are any changes.
  Also update ref before push.
inputs:
  commit-message:
    description: "commit message"
    required: true
  repository:
    description: "target repository"
    required: false
    default: "${{ github.repository }}"
  ref:
    description: "checkout ref to make git ref up to date."
    required: true
  github-token:
    description: "github token"
    required: true
  working-directory:
    description: "working directory to run git commands."
    required: false
    default: "."
runs:
  using: "composite"
  steps:
    - name: Diff
      id: diff
      run: |
        git add -N .
        if git diff --name-only --exit-code; then
          echo "No changes."
          echo "changed=0" | tee -a "${GITHUB_OUTPUT}"
        else
          echo "Changes detected."
          echo "changed=1" | tee -a "${GITHUB_OUTPUT}"
        fi
      shell: bash
      continue-on-error: true
      working-directory: ${{ inputs.working-directory }}

    - name: git commit
      if: ${{ steps.diff.outputs.changed == '1' }}
      run: |
        git remote set-url origin "https://github-actions:${GITHUB_TOKEN}@github.com/${{ inputs.repository }}"
        git config user.name  "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "$COMMIT_MESSAGE"
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        COMMIT_MESSAGE: ${{ inputs.commit-message }}
        GITHUB_TOKEN: ${{ inputs.github-token }}

    - name: git push
      if: ${{ steps.diff.outputs.changed == '1' }}
      run: |
        max_retries=3
        retry_count=0

        while [ $retry_count -lt $max_retries ]; do
          echo "try 'git push' ($((retry_count + 1))/${max_retries}) ..."
          if git push origin "$GIT_REF"; then
            echo "Push succeeded."
            exit 0
          fi

          # Push failed, increment retry count
          ((retry_count++))

          # If we haven't exceeded max retries, try to rebase and retry
          if [ $retry_count -lt $max_retries ]; then
            echo "Failed to push, try 'git pull --rebase' to resolve ..."
            if ! git pull origin "$GIT_REF" --rebase; then
              echo "'git pull --rebase' has problem, you need resolve conflict ..."
              exit 1
            fi
            echo "Rebase succeeded, will retry push."
          fi
        done

        echo "max retry reached, but failed to push."
        exit 1
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        GIT_REF: ${{ inputs.ref }}
