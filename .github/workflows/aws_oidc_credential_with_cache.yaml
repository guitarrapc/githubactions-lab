# note: you don't need this HACK since https://github.com/aws-actions/configure-aws-credentials/issues/299 fixed.
name: aws oidc credential with cache

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# github.job = job name
# github.run_id = unique id for workflow. re-run will use same id.
# github.run_attempt = incremented id for workflow. re-run will increment value.

env:
  cache-key: GitHubActions-auth-${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  # auth aws only once a workflow
  auth-aws:
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Configure AWS Credentials
        # must use "master", not "v1". v1 is not yet released to use latest role-to-assume.
        # Error: Credentials could not be loaded, please check your action inputs: Could not load credentials from any providers
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: GitHubActions-${{ github.run_id }}
          role-duration-seconds: 900 # minimum: 900sec, maximum: iam role session duration
      - name: Cache AWS Credentials
        uses: ./.github/actions/cache-aws-oidc-auth
        with:
          cache-key: ${{ env.cache-key }}

  # even parallel use, aws auth will use cache
  # make sure OS is same as cached runner.
  use-auth:
    needs: [auth-aws]
    strategy:
      matrix:
        name: ["a", "b", "c", "d", "e", "f", "g"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Configure AWS Credentials
        uses: ./.github/actions/restore-aws-oidc-auth
        with:
          cache-key: ${{ env.cache-key }}
      - name: get-caller-identity is allowed to run on role.
        run: aws sts get-caller-identity
