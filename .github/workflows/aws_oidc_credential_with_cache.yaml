name: aws oidc credential with cache

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# github.job = job name
# github.run_id = unique id for workflow. re-run will use same id.
# github.run_attempt = incremented id for workflow. re-run will increment value.

env:
  cache-key: GitHubActions-auth-${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  # auth aws only once a workflow
  auth-aws:
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/aws_oidc_auth
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: GitHubActions-${{ github.job }}-${{ github.run_id }}-${{ github.run_attempt }}
          cache-key: ${{ env.cache-key }}

  # even parallel use, aws auth will use cache
  use-auth:
    needs: [auth-aws]
    strategy:
      matrix:
        name: ["a", "b", "c", "d", "e", "f", "g"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/restore_aws_oidc_auth
        with:
          cache-key: ${{ env.cache-key }}
      - name: get-caller-identity is allowed to run on role.
        run: aws sts get-caller-identity
