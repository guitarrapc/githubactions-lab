name: detect crlf

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  FILE_PATTERN: ".*"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - id: changed-files
        uses: tj-actions/changed-files@v11.5
        with:
          separator: ","
      - name: Detect CRLF
        run: |
          echo "CRLF_FILES=" >> "$GITHUB_ENV"
          err=false

          for file in $(echo "${{ steps.changed-files.outputs.all_modified_files }}" | grep -e "${{ env.FILE_PATTERN }}" | sed -e "s/,/ /g"); do
            if file "${file}" | grep CRLF > /dev/null; then
              err=true
              echo "${file} detected as CRLF."
              crlf_files="${crlf_files} * ${file}${IFS}"
            fi
          done

          if [[ "${err}" == "true" ]]; then
            {
              echo "CRLF_FILES<<EOF"
              echo "${crlf_files}"
              echo "EOF"
            } >> "$GITHUB_ENV"
          fi
      - if: ${{ github.event_name == 'pull_request' && env.CRLF_FILES != '' }}
        name: Comment PR
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
            [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) detected CRLF files as follows.
            ${{ env.CRLF_FILES }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - if: ${{ env.CRLF_FILES != '' }}
        name: Exit action if detected
        run: exit 1
