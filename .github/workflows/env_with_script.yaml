name: env with script
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Add ENV and OUTPUT
        id: tag
        run: |
          echo "GIT_TAG=${GITHUB_REF#refs/heads/}" >> "$GITHUB_ENV"
          echo "git-tag=${GITHUB_REF#refs/heads/}" >> "$GITHUB_OUTPUT"
      - name: Show ENV and OUTPUT
        run: |
          echo ${{ env.GIT_TAG }}
          echo ${{ steps.tag.outputs.git-tag }}
      - name: Add ENV and OUTPUT by Script
        id: tag-script
        run: bash ./.github/scripts/setenv.sh --ref "${GITHUB_REF#refs/heads/}"
      - name: Show ENV and OUTPUT
        run: |
          echo ${{ env.GIT_TAG_SCRIPT }}
          echo ${{ steps.tag-script.outputs.git-tag }}
      - name: Add PATH
        run: echo "$HOME/foo/bar" >> "$GITHUB_PATH"
      - name: Show PATH
        run: echo "$PATH"

  windows:
    runs-on: windows-latest
    timeout-minutes: 3
    steps:
      - name: Add ENV and OUTPUT
        id: tag
        run: |
          echo "GIT_TAG=$(${env:GITHUB_REF} -replace 'refs/heads/','')" >> "${env:GITHUB_ENV}"
          echo "git-tag=$(${env:GITHUB_REF} -replace 'refs/heads/','')" >> "${env:GITHUB_OUTPUT}"
      - name: Show ENV and OUTPUT
        run: |
          echo "${{ env.GIT_TAG }}"
          echo "${{ steps.tag.outputs.git-tag }}"
      - name: Add ENV and OUTPUT by Script
        id: tag-script
        run: ./.github/scripts/setenv.ps1 -Ref "${env:GITHUB_REF}"
      - name: Show ENV and OUTPUT
        run: |
          echo "${{ env.GIT_TAG_SCRIPT }}"
          echo "${{ steps.tag-script.outputs.git-tag }}"
      - name: Add PATH
        run: echo "$HOME/foo/bar" >> "${env:GITHUB_PATH}"
      - name: Show PATH
        run: echo "${env:PATH}"
