name: env with script
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Add ENV and OUTPUT
        id: shell
        run: |
          if [[ "${{ startsWith(github.event_name, 'pull_request') }}" == "true" ]]; then
            echo "BRANCH=${{ github.head_ref }}" >> "$GITHUB_ENV"
            echo "branch=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "BRANCH=${{ github.ref_name }}" >> "$GITHUB_ENV"
            echo "branch=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Show ENV and OUTPUT
        run: |
          echo ${{ env.BRANCH }}
          echo ${{ steps.shell.outputs.branch }}
      - name: Add ENV and OUTPUT by Script
        id: script
        run: bash .github/scripts/setenv.sh --ref "${{ startsWith(github.event_name, 'pull_request') && github.head_ref || github.ref_name }}"
      - name: Show ENV and OUTPUT
        run: |
          echo ${{ env.BRANCH_SCRIPT }}
          echo ${{ steps.script.outputs.branch }}
      - name: Add PATH
        run: echo "$HOME/foo/bar" >> "$GITHUB_PATH"
      - name: Show PATH
        run: echo "$PATH"

  windows:
    runs-on: windows-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Add ENV and OUTPUT
        id: shell
        run: |
          if ("${{ startsWith(github.event_name, 'pull_request') }}" -eq "true") {
            echo "BRANCH=${{ github.head_ref }}" >> "${env:GITHUB_ENV}"
            echo "branch=${{ github.head_ref }}" >> "${env:GITHUB_OUTPUT}"
          } else {
            echo "BRANCH=${{ github.ref_name }}" >> "${env:GITHUB_ENV}"
            echo "branch=${{ github.ref_name }}" >> "${env:GITHUB_OUTPUT}"
          }
      - name: Show ENV and OUTPUT
        run: |
          echo "${{ env.BRANCH }}"
          echo "${{ steps.shell.outputs.branch }}"
      - name: Add ENV and OUTPUT by Script
        id: script
        run: ./.github/scripts/setenv.ps1 -Ref "${{ startsWith(github.event_name, 'pull_request') && github.head_ref || github.ref_name }}"
      - name: Show ENV and OUTPUT
        run: |
          echo "${{ env.BRANCH_SCRIPT }}"
          echo "${{ steps.script.outputs.branch }}"
      - name: Add PATH
        run: echo "${env:HOME}/foo/bar" >> "${env:GITHUB_PATH}"
      - name: Show PATH
        run: echo "${env:PATH}"
