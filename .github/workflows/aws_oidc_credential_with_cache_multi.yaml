name: aws oidc credential with cache (multi)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# github.job = job name
# github.run_id = unique id for workflow. re-run will use same id.
# github.run_attempt = incremented id for workflow. re-run will increment value.

env:
  cache-path: ~/.aws
  cache-key: ${{ runner.os }}-auth-${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  # auth aws only once a workflow
  auth-aws:
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/aws_oidc_auth_multi
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: GitHubActions-${{ github.job }}-${{ github.run_id }}-${{ github.run_attempt }}
          save-path: ${{ env.cache-path }}/auth-1
      - name: Configure AWS Credentials
        uses: ./.github/actions/aws_oidc_auth_multi
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_2 }}
          role-session-name: GitHubActions-${{ github.job }}-${{ github.run_id }}-${{ github.run_attempt }}
          save-path: ${{ env.cache-path }}/auth-2
      - name: Cache aws auth
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.cache-path }}
          key: ${{ inputs.cache-key }}

  use-auth:
    needs: [auth-aws]
    strategy:
      matrix:
        name: ["a", "b", "c", "d", "e", "f", "g"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/restore_aws_oidc_auth_multi
        with:
          cache-key: ${{ env.cache-key }}
          cache-path: ${{ env.cache-path }}
          save-path: ${{ env.cache-path }}/auth-1
      - name: get-caller-identity is allowed to run on role.
        run: aws sts get-caller-identity

  use-auth2:
    needs: [auth-aws]
    strategy:
      matrix:
        name: ["a", "b", "c", "d", "e", "f", "g"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/restore_aws_oidc_auth_multi
        with:
          cache-key: ${{ env.cache-key }}
          cache-path: ${{ env.cache-path }}
          save-path: ${{ env.cache-path }}/auth-2
      - name: get-caller-identity is allowed to run on role.
        run: aws sts get-caller-identity
