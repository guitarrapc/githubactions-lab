name: aws oidc credential with cache (multi)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# github.job = job name
# github.run_id = unique id for workflow. re-run will use same id.
# github.run_attempt = incremented id for workflow. re-run will increment value.

env:
  cache-key: GitHubActions-auth-${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  # auth aws only once a workflow
  auth-aws:
    strategy:
      fail-fast: true
      matrix:
        role: [AWS_ROLE_TO_ASSUME, AWS_ROLE_TO_ASSUME_2]
        include:
          - role: AWS_ROLE_TO_ASSUME
            cache-key: GitHubActions-auth-${{ github.run_id }}-${{ github.run_attempt }}
          - role: AWS_ROLE_TO_ASSUME_2
            cache-key: GitHubActions-auth-${{ github.run_id }}-${{ github.run_attempt }}-2
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/aws_oidc_auth
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ secrets[matrix.role] }}
          role-session-name: GitHubActions-${{ github.repository_owner }}-${{ github.event.repository.name }}
          cache-key: ${{ matrix.cache-key }}

  # even parallel use, aws auth will use cache
  # make sure OS is same as cached runner.
  use-auth:
    needs: [auth-aws]
    strategy:
      matrix:
        name: ["a", "b", "c", "d", "e", "f", "g"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/restore_aws_oidc_auth
        with:
          cache-key: ${{ env.cache-key }}
      - name: get-caller-identity is allowed to run on role.
        run: aws sts get-caller-identity

  use-auth2:
    needs: [auth-aws]
    strategy:
      matrix:
        name: ["a", "b", "c", "d", "e", "f", "g"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: ./.github/actions/restore_aws_oidc_auth
        with:
          cache-key: ${{ env.cache-key }}-2
      - name: get-caller-identity is allowed to run on role.
        run: aws sts get-caller-identity
